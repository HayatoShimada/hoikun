@page "/BarcodeScan"
@using Microsoft.JSInterop
@using hoikun.Pages.Attendance

<!-- カメラ映像を表示するための要素 -->
<video id="camera" autoplay playsinline style="width: 300px; height: auto; border: 1px solid #666;"></video>

<div class="mt-3">
    <button @onclick="StartCapture">Start Capture</button>
</div>

<div class="mt-3">
    <h4>スキャン結果: @ScannedIsbn</h4>
</div>

@code {
    // JSRuntime インジェクション
    [Inject] private IJSRuntime JS { get; set; } = default!;

    // DotNetObjectReferenceを保持
    private DotNetObjectReference<BarcodeScan>? objRef;

    // 読み取ったISBN
    private string? ScannedIsbn;

    // 初回レンダリング後にDotNetObjectReferenceを作成
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
        }
        base.OnAfterRender(firstRender);
    }

    // 「Start Capture」押下時にJSのbarcodeScan.startCaptureを呼び出す
    private async Task StartCapture()
    {
        if (objRef != null)
        {
            await JS.InvokeVoidAsync("barcodeScan.startCapture", objRef);
        }
    }

    // JS側から呼ばれるメソッド (バーコード検知時)
    [JSInvokable]
    public void CodeDetected(string isbn)
    {
        ScannedIsbn = isbn;
        // 画面更新
        StateHasChanged();
    }

    // コンポーネント破棄時にDotNetObjectReferenceをDispose
    public void Dispose()
    {
        objRef?.Dispose();
    }
}
