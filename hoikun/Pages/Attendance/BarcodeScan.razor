@page "/BarcodeScan"
@using Microsoft.JSInterop
@inject IJSRuntime JS
@inject IDbContextService dbContextService
@using hoikun.Data

<div class="container mt-4">
    <h2 class="text-center mb-4">勤退バーコードスキャン</h2>

    <div id="qr-reader" class="qr-reader-container"></div>

    <p class="text-center mt-3">読み取ったQRコード: @ScannedBarcode</p>

    <div class="form-group mt-4 text-center">
        <label>リロードまでの秒数:</label>
        <input type="number" min="1" max="30" @bind="ReloadSeconds" class="form-control d-inline-block" style="width: 100px; margin-left: 10px;" />
    </div>

    @if (IsModalVisible)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">@DialogTitle</h5>
                    </div>
                    <div class="modal-body">
                        @((MarkupString)DialogMessage)
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@code {
    private string? ScannedBarcode;
    private List<User>? users;
    private string DialogTitle = "";
    private string DialogMessage = "";
    private bool IsModalVisible = false;
    private int ReloadSeconds = 3;
    private bool _scannerStarted = false;
    private DotNetObjectReference<BarcodeScan>? objRef;

    protected override async Task OnInitializedAsync()
    {
        users = await dbContextService.GetUserAsync("Teacher");
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_scannerStarted)
        {
            _scannerStarted = true;
            objRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("startQrScanner", objRef);
        }
    }

    [JSInvokable]
    public async Task OnQrCodeScanned(string data)
    {
        ScannedBarcode = data;
        var today = DateTime.Today;
        var matchedUser = users?.FirstOrDefault(u => u.AADB2CUserId == data);
        string userName = matchedUser?.Name ?? "（該当ユーザーなし）";
        string userInfo = $"ユーザー名: {userName}";

        string clockInTime = "-", clockOutTime = "-";

        if (matchedUser?.Employee != null)
        {
            var employeeId = matchedUser.Employee.EmployeeId;
            var shifts = await dbContextService.GetShiftsAsync(q => q.Where(s => s.EmployeeId == employeeId && s.WorkDate == today));
            bool hasShift = shifts.Any();

            if (hasShift)
            {
                var timeCardsToday = await dbContextService.GetTimeCardAsync(q =>
                    q.Where(tc => tc.EmployeeId == employeeId && tc.WorkDate == today));
                var existingTimeCard = timeCardsToday.FirstOrDefault();

                if (existingTimeCard == null)
                {
                    var newCard = new TimeCard
                        {
                            EmployeeId = employeeId,
                            WorkDate = today,
                            ClockIn = DateTime.Now,
                            CreatedAt = DateTime.Now,
                            UpdatedAt = DateTime.Now
                        };
                    await dbContextService.AddTimeCardAsync(newCard);
                    clockInTime = newCard.ClockIn?.ToString("HH:mm") ?? "-";
                    ShowModal("出勤打刻成功", $"{userInfo}<br>出勤時間: {clockInTime}<br>（TimeCardが新規作成されました）");
                }
                else
                {
                    clockInTime = existingTimeCard.ClockIn?.ToString("HH:mm") ?? "-";
                    clockOutTime = existingTimeCard.ClockOut?.ToString("HH:mm") ?? "-";
                    ShowModal("すでに打刻済み", $"{userInfo}<br>出勤時間: {clockInTime}<br>退勤時間: {clockOutTime}");
                }
            }
            else
            {
                ShowModal("シフト未登録", $"{userInfo}<br>本日のシフトが登録されていません。");
            }
        }
        else
        {
            ShowModal("ユーザー不明", $"{userInfo}<br>QRコードのユーザーが見つかりません。");
        }

        StateHasChanged();
    }

    void ShowModal(string title, string message)
    {
        DialogTitle = title;
        DialogMessage = message;
        IsModalVisible = true;

        _ = Task.Run(async () =>
        {
            await Task.Delay(ReloadSeconds * 1000);
            await InvokeAsync(() =>
            {
                IsModalVisible = false;
                JS.InvokeVoidAsync("location.reload");
            });
        });
    }

    public void Dispose()
    {
        objRef?.Dispose();
    }
}
<style>
    .qr-reader-container {
        width: 100%;
        max-width: 640px;
        height: 480px;
        margin: 0 auto;
        border: 2px solid #ccc;
        border-radius: 10px;
        background-color: #000;
    }
</style>
