@page "/BarcodeScan"
@using Microsoft.JSInterop
@using hoikun.Pages.Attendance

<!-- カメラ映像を表示するための要素 -->
<DxGridLayout CssClass="h-100" ColumnSpacing="16px" RowSpacing="16px">
    <Rows>
        <DxGridLayoutRow Areas="item01" />
        <DxGridLayoutRow Areas="item02" />
        <DxGridLayoutRow Areas="item03" />
        <DxGridLayoutRow Areas="item04" />

    </Rows>

    <Columns>
        <DxGridLayoutColumn />
    </Columns>

    <Items>
        <DxGridLayoutItem Area="item01">
            <Template>
                <div id="camera"></div>
            </Template>
       </DxGridLayoutItem>
        <DxGridLayoutItem Area="item02">
            <Template>
                <div id="my_result">***</div>
            </Template>
        </DxGridLayoutItem>
        <DxGridLayoutItem Area="item03">
            <Template>
                <div id="my_barcode"></div>
            </Template>
        </DxGridLayoutItem>
        <DxGridLayoutItem>
            <Template>
                <DxButton Click="StartCapture">スキャン開始</DxButton>
            </Template>
        </DxGridLayoutItem>
    </Items>

</DxGridLayout>


<div class="mt-3">
    <h4>スキャン結果: @ScannedIsbn</h4>
</div>

@code {
    // JSRuntime インジェクション
    [Inject] private IJSRuntime JS { get; set; } = default!;

    // DotNetObjectReferenceを保持
    private DotNetObjectReference<BarcodeScan>? objRef;

    // 読み取ったISBN
    private string? ScannedIsbn;

    // 初回レンダリング後にDotNetObjectReferenceを作成
    protected override void OnAfterRender(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                objRef = DotNetObjectReference.Create(this);
            }
            base.OnAfterRender(firstRender);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        
    }

    // 「Start Capture」押下時にJSのbarcodeScan.startCaptureを呼び出す
    private async Task StartCapture()
    {
        try
        {
            if (objRef != null)
            {
                await JS.InvokeVoidAsync("barcodeScan.startCapture", objRef);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        
    }

    // JS側から呼ばれるメソッド (バーコード検知時)
    [JSInvokable]
    public void CodeDetected(string isbn)
    {
        ScannedIsbn = isbn;
        // 画面更新
        StateHasChanged();
    }

    // コンポーネント破棄時にDotNetObjectReferenceをDispose
    public void Dispose()
    {
        objRef?.Dispose();
    }
}
