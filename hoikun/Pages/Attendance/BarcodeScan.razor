@page "/BarcodeScan"
@using Microsoft.JSInterop
@using hoikun.Pages.Attendance

<!-- カメラ映像を表示するための要素 -->
<div id="camera"></div>
<div id="my_result">***</div>
			<div id="my_barcode"></div>
<div class="mt-3">
    <button @onclick="StartCapture">Start Capture</button>
</div>

<div class="mt-3">
    <h4>スキャン結果: @ScannedIsbn</h4>
</div>

@code {
    // JSRuntime インジェクション
    [Inject] private IJSRuntime JS { get; set; } = default!;

    // DotNetObjectReferenceを保持
    private DotNetObjectReference<BarcodeScan>? objRef;

    // 読み取ったISBN
    private string? ScannedIsbn;

    // 初回レンダリング後にDotNetObjectReferenceを作成
    protected override void OnAfterRender(bool firstRender)
    {
        try
        {
            if (firstRender)
            {
                objRef = DotNetObjectReference.Create(this);
            }
            base.OnAfterRender(firstRender);
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        
    }

    // 「Start Capture」押下時にJSのbarcodeScan.startCaptureを呼び出す
    private async Task StartCapture()
    {
        try
        {
            if (objRef != null)
            {
                await JS.InvokeVoidAsync("barcodeScan.startCapture", objRef);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine(ex.Message);
        }
        
    }

    // JS側から呼ばれるメソッド (バーコード検知時)
    [JSInvokable]
    public void CodeDetected(string isbn)
    {
        ScannedIsbn = isbn;
        // 画面更新
        StateHasChanged();
    }

    // コンポーネント破棄時にDotNetObjectReferenceをDispose
    public void Dispose()
    {
        objRef?.Dispose();
    }
}
